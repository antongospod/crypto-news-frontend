name: Blue-Green Deploy

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting (optional)
        run: pnpm run lint || echo "No linting configured"

      - name: Run tests (optional)
        run: pnpm run test || echo "No tests configured"

      - name: Blue-Green Deploy to VPS
        if: github.ref == 'refs/heads/master'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /opt/cryptocenter
            
            echo "üîÑ Starting Blue-Green Deployment..."
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git pull origin master
            
            # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "üî® Building new image..."
            docker compose build nuxt-app
            
            # –¢–µ–≥–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            docker tag cryptocenter_nuxt-app:latest cryptocenter_nuxt-app:new
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (Green) –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É
            echo "üü¢ Starting Green environment..."
            docker run -d --name nuxt-app-green \
              --network cryptocenter_app-network \
              -e NODE_ENV=production \
              -e NUXT_PUBLIC_SITE_NAME=CryptoCenter \
              -e NUXT_PUBLIC_SITE_URL=https://cryptocenter.finance \
              -p 3002:3000 \
              cryptocenter_nuxt-app:new
            
            # –ñ–¥–µ–º –ø–æ–∫–∞ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
            echo "‚è≥ Waiting for Green environment to start..."
            sleep 15
            
            # –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
            check_health() {
              local port=$1
              local max_attempts=6
              local attempt=1
            
              while [ $attempt -le $max_attempts ]; do
                echo "üè• Health check attempt $attempt/$max_attempts on port $port..."
            
                if curl -f -s --max-time 10 http://localhost:$port/ > /dev/null 2>&1; then
                  echo "‚úÖ Health check passed on port $port"
                  return 0
                fi
            
                if curl -f -s --max-time 10 http://localhost:$port/health > /dev/null 2>&1; then
                  echo "‚úÖ Health check passed on port $port (/health)"
                  return 0
                fi
            
                echo "‚ö†Ô∏è Health check failed on port $port, attempt $attempt/$max_attempts"
                sleep 5
                attempt=$((attempt + 1))
              done
            
              echo "‚ùå Health check failed after $max_attempts attempts"
              return 1
            }
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            if check_health 3002; then
              echo "‚úÖ Green environment is healthy, switching traffic..."
            
              # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º Nginx –Ω–∞ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
              docker exec nginx nginx -s reload 2>/dev/null || true
            
              # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
              sleep 5
            
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (Blue)
              echo "üî¥ Stopping Blue environment..."
              docker compose stop nuxt-app
              docker compose rm -f nuxt-app
            
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Green –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
              docker stop nuxt-app-green
            
              # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º Green –≤ –æ—Å–Ω–æ–≤–Ω–æ–π
              docker rename nuxt-app-green nuxt-app
            
              # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ docker-compose
              echo "üöÄ Starting new production environment..."
              docker compose up nuxt-app -d
            
              # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
              sleep 10
              if check_health 3000; then
                echo "üéâ Blue-Green deployment completed successfully!"
              else
                echo "‚ö†Ô∏è Warning: Final health check failed, but deployment completed"
              fi
            
            else
              echo "‚ùå Green environment failed health check, rolling back..."
            
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –Ω–µ—É–¥–∞—á–Ω—ã–π Green –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
              docker stop nuxt-app-green 2>/dev/null || true
              docker rm nuxt-app-green 2>/dev/null || true
              docker rmi cryptocenter_nuxt-app:new 2>/dev/null || true
            
              echo "üîÑ Blue environment is still running"
              exit 1
            fi
            
            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üßπ Cleaning up..."
            docker system prune -f
            docker image prune -f
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            echo "üìä Final status:"
            docker compose ps