name: Deploy to VPS

on:
  push:
    branches: [master]

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          command_timeout: 20m
          script: |
            set -e
            
            cd /opt/cryptocenter
            echo "üöÄ Starting deployment..."
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git stash || true
            git pull origin master
            
            # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "üî® Building Docker image..."
            docker compose build nuxt-app
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ nginx —Ä–∞–±–æ—Ç–∞–µ—Ç
            if ! docker ps | grep -q nginx; then
              echo "‚ö†Ô∏è  Nginx is not running, starting it..."
              docker compose up -d nginx
              sleep 5
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ staging –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            docker stop nuxt-app-staging 2>/dev/null || true
            docker rm nuxt-app-staging 2>/dev/null || true
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–∫ staging
            echo "üöÄ Starting new container..."
            docker run -d \
              --name nuxt-app-staging \
              --network cryptocenter_app-network \
              --restart unless-stopped \
              -e NODE_ENV=production \
              -e NUXT_PUBLIC_SITE_NAME=CryptoCenter \
              -e NUXT_PUBLIC_SITE_URL=https://cryptocenter.finance \
              cryptocenter-nuxt-app:latest
            
            # –ñ–¥–µ–º –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
            echo "‚è≥ Waiting for container to be ready..."
            sleep 15
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
            ATTEMPTS=0
            MAX_ATTEMPTS=20
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              if docker exec nginx wget -qO- http://nuxt-app-staging:3000 >/dev/null 2>&1; then
                echo "‚úÖ New container is healthy"
                break
              fi
              ATTEMPTS=$((ATTEMPTS + 1))
              echo "‚è≥ Health check attempt $ATTEMPTS/$MAX_ATTEMPTS..."
              sleep 3
            done
            
            if [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; then
              echo "‚ùå New container failed health checks"
              docker logs nuxt-app-staging --tail 50
              docker stop nuxt-app-staging
              docker rm nuxt-app-staging
              exit 1
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
            echo "üîÑ Switching containers..."
            docker compose stop nuxt-app
            docker compose rm -f nuxt-app
            docker compose up -d nuxt-app
            
            # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
            sleep 5
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∞–π—Ç
            echo "üîç Checking site availability..."
            SITE_OK=false
            for i in {1..10}; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -m 10 https://cryptocenter.finance || echo "000")
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                echo "‚úÖ Site is accessible (HTTP $HTTP_CODE)"
                SITE_OK=true
                break
              fi
              echo "‚è≥ Attempt $i/10 - HTTP $HTTP_CODE"
              sleep 2
            done
            
            if [ "$SITE_OK" = "false" ]; then
              echo "‚ùå Site is not accessible!"
              docker logs nuxt-app --tail 50
              exit 1
            fi
            
            # –£–¥–∞–ª—è–µ–º staging –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker stop nuxt-app-staging 2>/dev/null || true
            docker rm nuxt-app-staging 2>/dev/null || true
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
            echo "üîÑ Updating other services..."
            docker compose up -d nginx prometheus grafana cadvisor node-exporter
            
            # –û—á–∏—Å—Ç–∫–∞
            echo "üßπ Cleaning up..."
            docker image prune -f
            
            # –°—Ç–∞—Ç—É—Å
            echo ""
            echo "‚úÖ Deployment completed!"
            echo "üìä Container status:"
            docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "(nginx|nuxt-app)" || true