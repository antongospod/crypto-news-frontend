name: Blue-Green Deploy to VPS

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /opt/cryptocenter
            echo "üîÑ Starting Blue-Green deployment..."

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git stash push -m "Auto-stash $(date)" || true
            git reset --hard HEAD
            git pull origin master

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç –∏–∑ nginx –∫–æ–Ω—Ñ–∏–≥–∞
            CURRENT_PORT=$(grep -o "172.20.0.1:[0-9]*" nginx.conf | cut -d: -f2)

            if [ "$CURRENT_PORT" = "3000" ]; then
              NEW_PORT=3002
              COLOR="üü¢ Green"
              echo "üîµ Current: Blue (3000) ‚Üí Deploying: $COLOR ($NEW_PORT)"
            else
              NEW_PORT=3000
              COLOR="üîµ Blue"
              echo "üü¢ Current: Green (3002) ‚Üí Deploying: $COLOR ($NEW_PORT)"
            fi

            # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "üî® Building new version..."
            docker compose build nuxt-app

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –Ω–æ–≤–æ–º –ø–æ—Ä—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
            docker stop nuxt-app-staging 2>/dev/null || true
            docker rm nuxt-app-staging 2>/dev/null || true

            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ staging –ø–æ—Ä—Ç—É
            echo "üöÄ Starting new version on port $NEW_PORT..."
            docker run -d \
              --name nuxt-app-staging \
              --network cryptocenter_app-network \
              -p $NEW_PORT:3000 \
              -e NODE_ENV=production \
              -e NUXT_PUBLIC_SITE_NAME=CryptoCenter \
              -e NUXT_PUBLIC_SITE_URL=https://cryptocenter.finance \
              cryptocenter-nuxt-app

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            echo "‚è≥ Waiting for new version to start..."
            sleep 20

            # Health check –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
            echo "üîç Health checking new version..."
            for i in {1..10}; do
              if curl -f -s http://127.0.0.1:$NEW_PORT > /dev/null; then
                echo "‚úÖ New version is healthy"
                HEALTH_OK=true
                break
              fi
              echo "‚è≥ Attempt $i/10 - waiting..."
              sleep 3
            done

            if [ "$HEALTH_OK" != "true" ]; then
              echo "‚ùå New version failed health check!"
              docker logs nuxt-app-staging --tail 50
              docker stop nuxt-app-staging
              docker rm nuxt-app-staging
              exit 1
            fi

            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º nginx –Ω–∞ –Ω–æ–≤—ã–π –ø–æ—Ä—Ç
            echo "üîÑ Switching nginx to new version..."
            cp nginx.conf nginx.conf.backup
            sed -i "s/172.20.0.1:$CURRENT_PORT/172.20.0.1:$NEW_PORT/g" nginx.conf

            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            docker exec nginx nginx -s reload

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ nginx –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ
            sleep 5
            if curl -f -s https://cryptocenter.finance > /dev/null; then
              echo "‚úÖ Nginx successfully switched to new version"

              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
              echo "üõë Stopping old version..."
              if [ "$NEW_PORT" = "3000" ]; then
                # –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 3002
                fuser -k 3002/tcp 2>/dev/null || true
              else
                # –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 3000
                fuser -k 3000/tcp 2>/dev/null || true
              fi

              # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º staging –≤ –æ—Å–Ω–æ–≤–Ω–æ–π
              docker stop nuxt-app-staging
              docker rename nuxt-app-staging nuxt-app-$NEW_PORT
              docker start nuxt-app-$NEW_PORT

              echo "‚úÖ $COLOR deployment completed successfully!"

            else
              echo "‚ùå Nginx switch failed, rolling back..."
              cp nginx.conf.backup nginx.conf
              docker exec nginx nginx -s reload
              docker stop nuxt-app-staging
              docker rm nuxt-app-staging
              exit 1
            fi

            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            echo "üîÑ Updating other services..."
            docker compose up -d --no-deps nginx prometheus grafana cadvisor node-exporter

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            echo "üìä Final status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            # –û—á–∏—Å—Ç–∫–∞
            echo "üßπ Cleaning up..."
            docker system prune -f

            echo "‚úÖ Blue-Green deployment completed!"
            echo "üåê Site available at: https://cryptocenter.finance"
