name: Blue-Green Deploy to VPS

on:
  push:
    branches: [master]

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /opt/cryptocenter
            echo "ğŸš€ Starting Blue-Green deployment..."

            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´
            git stash push -m "Auto-stash $(date)" || true
            git reset --hard HEAD
            git pull origin master

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ°ĞºĞ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½
            NGINX_CONFIG_CONTENT=$(cat nginx.conf)
            if echo "$NGINX_CONFIG_CONTENT" | grep -q "server nuxt-app:3000.*backup"; then
              # nuxt-app Ğ½Ğ° backup, Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ staging
              CURRENT_ACTIVE="staging"
              NEW_ACTIVE="main"
              echo "ğŸ”µ Current: Staging â†’ Deploying: Main"
            else
              # nuxt-app Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½, Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğ½Ğ° staging  
              CURRENT_ACTIVE="main"
              NEW_ACTIVE="staging"
              echo "ğŸŸ¢ Current: Main â†’ Deploying: Staging"
            fi

            # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ·
            echo "ğŸ”¨ Building new version..."
            docker compose build nuxt-app

            # Ğ£Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ staging ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
            echo "ğŸ§¹ Cleaning up staging container..."
            docker stop nuxt-app-staging 2>/dev/null || true
            docker rm -f nuxt-app-staging 2>/dev/null || true

            if [ "$NEW_ACTIVE" = "main" ]; then
              # Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              echo "ğŸš€ Starting main container..."
              docker compose up -d nuxt-app
            
              # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
              echo "â³ Waiting for main container to start..."
              sleep 20
            
              # Health check
              echo "ğŸ” Health checking main container..."
              HEALTH_OK=false
              for i in {1..10}; do
                if docker exec nginx wget -qO- http://nuxt-app:3000 >/dev/null 2>&1; then
                  echo "âœ… Main container is healthy"
                  HEALTH_OK=true
                  break
                fi
                echo "â³ Attempt $i/10 - waiting..."
                sleep 3
              done
            
              if [ "$HEALTH_OK" != "true" ]; then
                echo "âŒ Main container failed health check!"
                docker logs nuxt-app --tail 50
                exit 1
              fi
            
              # ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ nginx Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              echo "ğŸ”„ Switching nginx to main container..."
              cp nginx.conf nginx.conf.backup
            
              # Ğ”ĞµĞ»Ğ°ĞµĞ¼ nuxt-app primary, Ğ° staging backup
              sed -i 's/server nuxt-app:3000.*backup;/server nuxt-app:3000 max_fails=3 fail_timeout=30s;/' nginx.conf
              sed -i 's/server nuxt-app-staging:3000[^;]*;/server nuxt-app-staging:3000 max_fails=3 fail_timeout=30s backup;/' nginx.conf
            
            else
              # Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° staging ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              echo "ğŸš€ Starting staging container..."
              docker run -d \
                --name nuxt-app-staging \
                --network cryptocenter_app-network \
                -e NODE_ENV=production \
                -e NUXT_PUBLIC_SITE_NAME=CryptoCenter \
                -e NUXT_PUBLIC_SITE_URL=https://cryptocenter.finance \
                cryptocenter-nuxt-app

              # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
              echo "â³ Waiting for staging container to start..."
              sleep 20

              # Health check staging ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
              echo "ğŸ” Health checking staging container..."
              HEALTH_OK=false
              for i in {1..10}; do
                if docker exec nginx wget -qO- http://nuxt-app-staging:3000 >/dev/null 2>&1; then
                  echo "âœ… Staging container is healthy"
                  HEALTH_OK=true
                  break
                fi
                echo "â³ Attempt $i/10 - waiting..."
                sleep 3
              done

              if [ "$HEALTH_OK" != "true" ]; then
                echo "âŒ Staging container failed health check!"
                docker logs nuxt-app-staging --tail 50
                docker stop nuxt-app-staging
                docker rm nuxt-app-staging
                exit 1
              fi

              # ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ nginx Ğ½Ğ° staging ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              echo "ğŸ”„ Switching nginx to staging container..."
              cp nginx.conf nginx.conf.backup
            
              # Ğ”ĞµĞ»Ğ°ĞµĞ¼ staging primary, Ğ° nuxt-app backup
              sed -i 's/server nuxt-app-staging:3000.*backup;/server nuxt-app-staging:3000 max_fails=3 fail_timeout=30s;/' nginx.conf
              sed -i 's/server nuxt-app:3000[^;]*;/server nuxt-app:3000 max_fails=3 fail_timeout=30s backup;/' nginx.conf
            fi

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
            if ! docker exec nginx nginx -t; then
              echo "âŒ Invalid nginx configuration!"
              cp nginx.conf.backup nginx.conf
              exit 1
            fi

            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ nginx
            docker exec nginx nginx -s reload

            # Ğ’Ğ°Ğ¶Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: Ğ¶Ğ´ĞµĞ¼ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ nginx Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ» ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
            sleep 5

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ÑĞ°Ğ¹Ñ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ (Ğ±Ğ¾Ğ»ĞµĞµ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°)
            echo "ğŸ” Checking site availability..."
            SITE_OK=false
            for i in {1..5}; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://cryptocenter.finance 2>/dev/null || echo "000")
              if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
                echo "âœ… Site is accessible (HTTP $HTTP_CODE)"
                SITE_OK=true
                break
              fi
              echo "â³ Attempt $i/5 - Got HTTP $HTTP_CODE, retrying..."
              sleep 3
            done

            if [ "$SITE_OK" != "true" ]; then
              echo "âŒ Site check failed, rolling back..."
              cp nginx.conf.backup nginx.conf
              docker exec nginx nginx -s reload
            
              if [ "$NEW_ACTIVE" = "staging" ]; then
                docker stop nuxt-app-staging 2>/dev/null || true
                docker rm nuxt-app-staging 2>/dev/null || true
              fi
              exit 1
            fi

            # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
            if [ "$NEW_ACTIVE" = "main" ]; then
              echo "ğŸ›‘ Stopping old staging container..."
              # Staging ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ ÑƒĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ
              echo "âœ… Main deployment completed!"
            else
              echo "ğŸ›‘ Stopping old main container..."
              docker compose stop nuxt-app 2>/dev/null || true
              echo "âœ… Staging deployment completed!"
            fi

            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
            echo "ğŸ”„ Updating other services..."
            docker compose up -d --no-deps nginx prometheus grafana cadvisor node-exporter

            # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            echo "ğŸ“Š Final status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
            echo "ğŸ§¹ Cleaning up..."
            docker image prune -f

            echo "âœ… Blue-Green deployment completed!"
            echo "ğŸŒ Site available at: https://cryptocenter.finance"
            echo "ğŸ¯ Active version: $NEW_ACTIVE"