# .github/workflows/deploy.yml
name: Deploy to VPS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Deploy to VPS
        if: github.ref == 'refs/heads/master'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /opt/cryptocenter
            git pull origin master
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ· Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼ Ñ‚ĞµĞ³Ğ¾Ğ¼
            docker compose build nuxt-app
            docker tag cryptocenter_nuxt-app:latest cryptocenter_nuxt-app:new
            
            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ½Ğ° Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¼ Ğ¿Ğ¾Ñ€Ñ‚Ñƒ
            docker run -d --name nuxt-app-new \
              --network cryptocenter_app-network \
              -e NODE_ENV=production \
              -e NUXT_PUBLIC_SITE_NAME=CryptoCenter \
              -e NUXT_PUBLIC_SITE_URL=https://cryptocenter.finance \
              -p 3001:3000 \
              cryptocenter_nuxt-app:new
            
            # Ğ–Ğ´ĞµĞ¼ Ğ¿Ğ¾ĞºĞ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑÑ
            sleep 10
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
            if curl -f http://localhost:3001/health 2>/dev/null || curl -f http://localhost:3001/ 2>/dev/null; then
              echo "âœ… New container is healthy"
            
              # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€Ñ‚
              sed -i 's/nuxt-app:3000/host.docker.internal:3001/g' nginx.conf
              docker compose restart nginx
            
              # Ğ–Ğ´ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
              sleep 5
            
              # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              docker compose stop nuxt-app
              docker compose rm -f nuxt-app
            
              # ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              docker stop nuxt-app-new
              docker rename nuxt-app-new nuxt-app-temp
            
              # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼
              docker compose up nuxt-app -d
            
              # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
              sed -i 's/host.docker.internal:3001/nuxt-app:3000/g' nginx.conf
              docker compose restart nginx
            
              # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              docker rm nuxt-app-temp 2>/dev/null || true
            
            else
              echo "âŒ New container failed to start, keeping old one"
              docker stop nuxt-app-new 2>/dev/null || true
              docker rm nuxt-app-new 2>/dev/null || true
              exit 1
            fi
            
            # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
            docker system prune -f
            echo "ğŸ‰ Zero-downtime deployment completed!"
            docker compose ps